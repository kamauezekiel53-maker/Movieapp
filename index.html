<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MovieHub ‚Äî Enhanced</title>
<style>
:root{
  --bg:#0a0a0a; --card:#141414; --muted:#9aa0a6; --accent:#ff3b3b;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; color:#fff; background:var(--bg); line-height:1.4; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
header{position:sticky; top:0; z-index:30; display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:12px; padding:14px 18px; background:rgba(17,17,17,0.9); backdrop-filter: blur(6px);}
.logo{margin:0; font-size:20px}
.controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
#search{padding:8px 12px; width:200px; border-radius:10px; border:0; background:#111; color:#ddd;}
#genre{padding:8px 12px; border-radius:10px; border:0; background:#111; color:#ddd;}
button{border:0; background:transparent; color:#ddd; font-size:18px; cursor:pointer}
.movie-grid{display:grid; gap:18px; padding:22px; grid-template-columns: repeat(auto-fill, minmax(150px,1fr));}
.movie{background:var(--card); border-radius:12px; padding:8px; cursor:pointer; transition: transform .22s ease, box-shadow .22s ease; display:flex; flex-direction:column; gap:8px; align-items:center;}
.movie:hover{ transform:translateY(-6px) scale(1.02); box-shadow:0 8px 30px rgba(0,0,0,0.6);}
.movie img{ width:100%; border-radius:8px; display:block; aspect-ratio:2/3; object-fit:cover }
.movie h3{ margin:0; font-size:14px; text-align:center; color:#fff }
.meta{ display:flex; gap:8px; font-size:12px; color:var(--muted); align-items:center }
.fav-btn{ background:transparent; border:0; color:var(--muted); cursor:pointer; font-size:18px }
.details{position:fixed; inset:0; background:linear-gradient(180deg, rgba(0,0,0,0.96), rgba(0,0,0,0.98)); padding:28px; overflow:auto; display:flex; gap:20px; align-items:flex-start; z-index:50;}
.details .content{ max-width:980px; margin:auto; display:grid; grid-template-columns: 320px 1fr; gap:20px; align-items:start}
.details img{ width:100%; border-radius:10px; display:block; }
.details h1{ margin:0; font-size:26px }
.details p{ color:var(--muted) }
.close{ position:absolute; right:18px; top:14px; font-size:28px; cursor:pointer }
.hidden{ display:none }
.loader{ text-align:center; padding:40px; color:var(--muted) }
footer{ text-align:center; padding:12px 0; color:var(--muted) }
@media (max-width:720px){
  .details .content{ grid-template-columns: 1fr; }
  header{ padding:12px }
  #search{ width:140px }
}
</style>
</head>
<body>
<header>
  <h1 class="logo">üé¨ MovieHub</h1>
  <div class="controls">
    <input id="search" type="search" placeholder="Search movies..." />
    <select id="genre">
      <option value="">All genres</option>
    </select>
    <button id="toggle-popular">üî• Popular</button>
    <button id="toggle-top">‚≠ê Top Rated</button>
    <button id="toggle-favs" title="Show favorites">üìÇ</button>
    <button id="dark-toggle" title="Toggle dark mode">üåô</button>
  </div>
</header>
<main>
  <section id="movies" class="movie-grid" aria-live="polite"></section>
  <div id="loader" class="loader hidden">Loading‚Ä¶</div>
</main>
<div id="movie-details" class="details hidden" role="dialog" aria-modal="true"></div>
<footer>
  <small>Data from TMDb ¬∑ Client-side demo</small>
</footer>
<script>
const API_KEY = "7cc9abef50e4c94689f48516718607be";
const BASE_URL = "https://api.themoviedb.org/3";

const moviesContainer = document.getElementById("movies");
const searchInput = document.getElementById("search");
const details = document.getElementById("movie-details");
const loader = document.getElementById("loader");
const toggleFavsBtn = document.getElementById("toggle-favs");
const darkToggle = document.getElementById("dark-toggle");
const genreSelect = document.getElementById("genre");
const togglePopularBtn = document.getElementById("toggle-popular");
const toggleTopBtn = document.getElementById("toggle-top");

let currentList = [];
let page = 1;
let currentType = 'popular';
let currentGenre = '';
let showOnlyFavs = false;
let loadingMore = false;

function showLoader(show = true){ loader.classList.toggle("hidden", !show); }
function poster(path){ return path ? `https://image.tmdb.org/t/p/w500${path}` : "data:image/svg+xml;charset=utf-8,<svg xmlns='http://www.w3.org/2000/svg' width='300' height='450'/>"; }
function getFavs(){ try{ return JSON.parse(localStorage.getItem("movie_favs")||"[]") }catch(e){ return [] } }
function saveFavs(ids){ localStorage.setItem("movie_favs", JSON.stringify(ids)) }

async function apiFetch(path){ showLoader(true); try{ const res = await fetch(`${BASE_URL}${path}${path.includes('?') ? '&' : '?'}api_key=${API_KEY}`); if(!res.ok) throw new Error("Network error"); return await res.json(); }finally{ showLoader(false); } }

async function fetchGenres(){
  const data = await apiFetch('/genre/movie/list');
  data.genres.forEach(g => genreSelect.innerHTML += `<option value="${g.id}">${g.name}</option>`);
}
function buildQuery(){ return `/${currentType}?page=${page}${currentGenre ? `&with_genres=${currentGenre}` : ''}`; }

async function loadMovies(reset=false){
  if(reset){ page=1; currentList=[]; moviesContainer.innerHTML=''; }
  if(loadingMore) return;
  loadingMore = true;
  const data = await apiFetch(buildQuery());
  currentList = [...currentList, ...(data.results||[])];
  renderMovies(currentList);
  loadingMore = false;
}

function renderMovies(list){
  moviesContainer.innerHTML = "";
  const favs = getFavs();
  const toShow = showOnlyFavs ? list.filter(m => favs.includes(m.id)) : list;
  if(!toShow.length){ moviesContainer.innerHTML = `<p style="color:var(--muted);padding:20px">${showOnlyFavs ? "No favorites yet" : "No movies found"}</p>`; return; }
  toShow.forEach(movie => {
    const el = document.createElement("div");
    el.className = "movie";
    el.innerHTML = `<img loading="lazy" src="${poster(movie.poster_path)}" alt="${movie.title}" /><h3>${movie.title}</h3><div class="meta"><span>${movie.vote_average.toFixed(1)}</span><button class="fav-btn" data-id="${movie.id}" aria-label="Toggle favorite">${ favs.includes(movie.id) ? "‚òÖ" : "‚òÜ" }</button></div>`;
    el.addEventListener("click", (e) => { if(e.target.closest('.fav-btn')) return; showMovieDetails(movie.id); });
    el.querySelector('.fav-btn').addEventListener('click', ev => { ev.stopPropagation(); toggleFavorite(parseInt(ev.target.dataset.id)); ev.target.textContent = getFavs().includes(movie.id) ? "‚òÖ" : "‚òÜ"; });
    moviesContainer.appendChild(el);
  });
}

let searchTimer = null;
searchInput.addEventListener("input", () => {
  clearTimeout(searchTimer);
  const q = searchInput.value.trim();
  searchTimer = setTimeout(async () => {
    if(q.length > 2){
      const data = await apiFetch(`/search/movie?query=${encodeURIComponent(q)}&page=1`);
      currentList = data.results || [];
      renderMovies(currentList);
    } else { loadMovies(true); }
  }, 300);
});

async function showMovieDetails(id){
  details.innerHTML = `<div class="close" id="close-details">‚úñ</div><div style="padding:20px;color:var(--muted)">Loading‚Ä¶</div>`;
  details.classList.remove("hidden");
  document.getElementById("close-details").addEventListener("click", () => details.classList.add("hidden"));
  document.addEventListener("keydown", escClose);
  const movie = await apiFetch(`/movie/${id}?append_to_response=videos,credits`);
  const trailer = (movie.videos?.results||[]).find(v => v.type === "Trailer" && v.site === "YouTube");
  const cast = (movie.credits?.cast||[]).slice(0,6).map(c=>c.name).join(", ");
  details.innerHTML = `<span class="close" id="close-details-2">‚úñ</span><div class="content"><div><img src="${poster(movie.poster_path)}" alt="${movie.title}" /></div><div><h1>${movie.title}</h1><p style="color:var(--muted)"><strong>Rating:</strong> ${movie.vote_average.toFixed(1)} ¬∑ <strong>Runtime:</strong> ${movie.runtime || '‚Äî'} min</p><p style="color:var(--muted)"><strong>Cast:</strong> ${cast || '‚Äî'}</p><p>${movie.overview || 'No overview available.'}</p>${ trailer ? `<div style="margin-top:12px"><iframe width="100%" height="360" src="https://www.youtube.com/embed/${trailer.key}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>` : '<p style="color:var(--muted)">No trailer available</p>' }</div></div>`;
  document.getElementById("close-details-2").addEventListener("click", () => details.classList.add("hidden"));
}

function escClose(e){ if(e.key==='Escape') details.classList.add("hidden"); }

function toggleFavorite(id){ const favs = getFavs(); const i = favs.indexOf(id); if(i===-1) favs.push(id); else favs.splice(i,1); saveFavs(favs); }

toggleFavsBtn.addEventListener("click", () => { showOnlyFavs = !showOnlyFavs; toggleFavsBtn.textContent = showOnlyFavs ? "‚≠ê" : "üìÇ"; renderMovies(currentList); });
darkToggle.addEventListener("click", () => { const isDark = document.documentElement.style.getPropertyValue('--bg') === '#0a0a0a'; if(isDark){ document.documentElement.style.setProperty('--bg','#fff'); document.documentElement.style.setProperty('--card','#f6f6f6'); document.documentElement.style.setProperty('--muted','#333'); document.documentElement.style.setProperty('--accent','#0066ff'); document.body.style.color = '#111'; darkToggle.textContent = '‚òÄÔ∏è'; } else { document.documentElement.style.setProperty('--bg','#0a0a0a'); document.documentElement.style.setProperty('--card','#141414'); document.documentElement.style.setProperty('--muted','#9aa0a6'); document.documentElement.style.setProperty('--accent','#ff3b3b'); document.body.style.color = '#fff'; darkToggle.textContent = 'üåô'; } });
togglePopularBtn.addEventListener("click", () => { currentType='popular'; loadMovies(true); });
toggleTopBtn.addEventListener("click", () => { currentType='top_rated'; loadMovies(true); });
genreSelect.addEventListener("change", () => { currentGenre = genreSelect.value; loadMovies(true); });

window.addEventListener("scroll", () => { if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 500 && !loadingMore){ page++; loadMovies(); } });

fetchGenres();
loadMovies();
</script>
</body>
  </html>
